---
title: "Análise: Confiança do Consumidor e Consumo no Varejo Elasticidade e Estrutura
  de Consumo no Brasil (2006-2025)"
author: "Luiz Fernando Batista"
date: "2025-10-02"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.show = 'hold', fig.width = 8, fig.height = 6)
``` 


# ------------------------------------------------------------
# 1. Carregar pacotes
# ------------------------------------------------------------
library(tidyverse)
library(readxl)
library(janitor)
library(lubridate)
library(stringr)
library(scales)

# ------------------------------------------------------------
# 2. Importar bases de dados
# ------------------------------------------------------------

# PMC - Pesquisa Mensal do Comércio
pmc_raw    <- read_excel("C:/Users/Lenovo/OneDrive/Documentos/PMC(2).xlsx", skip = 0, n_max = 16)
pmc_raw_sa <- read_excel("C:/Users/Lenovo/OneDrive/Documentos/PMC(2).xlsx", skip = 16)

# ICC - Índice de Confiança do Consumidor
icc_raw <- read_excel("C:/Users/Lenovo/OneDrive/Documentos/ICC(1).xlsx")

# ------------------------------------------------------------
# 3. Limpeza e padronização da base ICC
# ------------------------------------------------------------
icc <- icc_raw %>%
  clean_names() %>% 
  rename(data = 1, icc_sa = 2) %>%
  mutate(data = as.Date(data)) %>%
  filter(year(data) >= 2006) %>%
  arrange(data)

# ------------------------------------------------------------
# 4. Função para limpar tabelas PMC
# ------------------------------------------------------------
limpar_pmc_secao <- function(df, label) {
  ncols <- ncol(df)
  colnames(df)[1:2] <- c("local", "atividade")
  
  # Identificar linha de datas
  hdr <- which.max(apply(df[, 3:ncols], 1, function(x) suppressWarnings(sum(!is.na(as.numeric(as.character(x)))))))
  
  # Nomear colunas com datas
  colnames(df) <- c("local", "atividade", make.unique(as.character(unlist(df[hdr, 3:ncols]))))
  
  # Selecionar apenas linhas com dados reais
  dados <- df %>%
    slice((hdr + 2):n()) %>%
    filter(!is.na(atividade)) %>%
    filter(!str_detect(atividade, regex("Atividade|Total|Geral|ajuste", ignore_case = TRUE))) %>% 
    filter(row_number() <= which(str_detect(atividade, "Fonte"))[1] - 1 | is.na(which(str_detect(atividade, "Fonte"))[1]))
  
  # Converter e pivotar
  long <- dados %>%
    mutate(across(3:ncol(.), as.character)) %>%
    pivot_longer(cols = 3:ncol(.), names_to = "periodo", values_to = "valor_chr") %>%
    mutate(
      valor_chr = str_replace_all(valor_chr, "[^0-9,.-]", ""),
      valor_chr = str_replace(valor_chr, ",", "."),
      valor = as.numeric(valor_chr),
      data = case_when(
        str_detect(periodo, "^[0-9]+$") ~ as.Date(as.numeric(periodo), origin = "1899-12-30"),
        str_detect(periodo, "^[0-9]{4}-[0-9]{2}") ~ suppressWarnings(ym(periodo)),
        TRUE ~ suppressWarnings(as.Date(periodo, format = "%Y-%m-%d"))
      )
    ) %>%
    filter(!is.na(data), !is.na(valor), year(data) >= 2006, valor > 0 & valor < 1e9) %>%
    select(data, atividade, valor) %>%
    mutate(ajuste = label)
  
  return(long)
}

# ------------------------------------------------------------
# 5. Limpar e unir bases PMC
# ------------------------------------------------------------
pmc_clean_nsa <- limpar_pmc_secao(pmc_raw, "sem_ajuste")
pmc_clean_sa  <- limpar_pmc_secao(pmc_raw_sa, "com_ajuste")

pmc_final <- bind_rows(pmc_clean_nsa, pmc_clean_sa) %>%
  mutate(ajuste = factor(ajuste, levels = c("com_ajuste", "sem_ajuste"))) %>%
  arrange(data, atividade, ajuste)

# ------------------------------------------------------------
# 6. Integrar PMC com ICC
# ------------------------------------------------------------
base_integrada <- pmc_final %>%
  left_join(icc, by = "data") %>%
  relocate(ajuste, .after = valor) %>%
  relocate(icc_sa, .after = ajuste)

# ------------------------------------------------------------
# 7. Classificar categorias: Essenciais vs. Não essenciais
# ------------------------------------------------------------
essenciais <- c(
  "Hipermercados, supermercados, produtos alimentícios, bebidas e fumo",
  "Artigos farmacêuticos, médicos, ortopédicos, de perfumaria e cosméticos"
)

base_classificada <- base_integrada %>%
  filter(ajuste == "com_ajuste") %>%
  mutate(tipo = if_else(atividade %in% essenciais, "Essenciais", "Não essenciais")) %>%
  group_by(data, tipo) %>%
  summarise(valor_total = sum(valor, na.rm = TRUE), icc_sa = mean(icc_sa, na.rm = TRUE), .groups = "drop") %>%
  group_by(data) %>%
  mutate(participacao = valor_total / sum(valor_total) * 100)

# ============================================================
# GRÁFICO 1 - Estrutura de Consumo ao Longo do Tempo
# ============================================================

ggplot(base_classificada, aes(x = data, y = participacao, color = tipo)) +
  geom_line(linewidth = 1.2) +
  geom_line(aes(y = icc_sa * 1.5), color = "black", linetype = "dashed", linewidth = 1) +
  scale_y_continuous(
    name = "Participação no Consumo (%)",
    sec.axis = sec_axis(~ . / 1.5, name = "Índice de Confiança do Consumidor (ICC)")
  ) +
  scale_color_manual(values = c("Essenciais" = "#E64B35", "Não essenciais" = "#4DBBD5")) +
  labs(
    title = "Participação no Consumo: Essenciais vs. Não Essenciais",
    subtitle = "Mudança estrutural ao longo do tempo e relação com a confiança do consumidor",
    x = "Data",
    y = "Participação (%)",
    color = "Categoria"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 18),
    plot.subtitle = element_text(size = 14),
    legend.position = "top",
    axis.title.y.right = element_text(margin = margin(l = 10))
  )

# ============================================================
# GRÁFICO 2 - Elasticidade do Consumo em relação ao ICC
# ============================================================

elasticidade_df <- base_integrada %>%
  filter(ajuste == "com_ajuste") %>%
  group_by(data, categoria = if_else(atividade %in% essenciais, "Essenciais", "Não essenciais")) %>%
  summarise(receita_total = sum(valor, na.rm = TRUE),
            icc_sa = mean(icc_sa, na.rm = TRUE), .groups = "drop") %>%
  arrange(data, categoria) %>%
  group_by(categoria) %>%
  mutate(
    var_receita = (receita_total / lag(receita_total) - 1) * 100,
    var_icc = (icc_sa / lag(icc_sa) - 1) * 100
  ) %>%
  ungroup() %>%
  filter(!is.na(var_receita), !is.na(var_icc))

ggplot(elasticidade_df, aes(x = var_icc, y = var_receita, color = categoria)) +
  geom_point(alpha = 0.3, size = 1.5) +
  geom_smooth(method = "lm", se = TRUE, size = 1.5, alpha = 0.25) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "gray50") +
  geom_vline(xintercept = 0, linetype = "dotted", color = "gray50") +
  labs(
    title = "Sensibilidade do Consumo às Variações no ICC",
    subtitle = "Inclinação das linhas mostra a reação do consumo às mudanças de confiança",
    x = "Variação percentual do ICC (%)",
    y = "Variação percentual do consumo (%)",
    color = "Categoria"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  ) +
  scale_color_manual(values = c("Essenciais" = "#D55E00", "Não essenciais" = "#0072B2"))



# Glossário
  
## Glossário
  
# **ICC (Índice de Confiança do Consumidor)**: 
# Indicador desenvolvido pela FGV (Fundação Getúlio Vargas) que reflete a confiança dos consumidores 
# em relação à situação econômica atual e futura. O índice é composto por uma série de indicadores 
# econômicos que medem o otimismo ou pessimismo da população em relação à economia. 
# Para a análise, utilizamos o ICC com **ajuste sazonal**, que remove as variações sazonais nos dados, 
# permitindo uma interpretação mais clara das tendências de longo prazo. Além de um corte nos dados anteriores a 2006
  
# **PMC (Pesquisa Mensal do Comércio)**: 
# Dados divulgados pelo **IBGE (Instituto Brasileiro de Geografia e Estatística)**, 
# que fornece informações sobre o desempenho do comércio varejista no Brasil. 
# A pesquisa apresenta duas séries de dados: uma com ajuste sazonal e outra sem ajuste sazonal. 
# A série de dados foi coletada desde 2000, mas para a análise, foram considerados apenas os dados a partir de 2006, 
# devido à disponibilidade e qualidade dos dados.
  
# **Ajuste Sazonal**: 
# Processo utilizado para eliminar as flutuações sazonais nos dados de uma série temporal. 
# Esse ajuste é fundamental para identificar tendências de longo prazo e entender melhor os padrões de consumo, 
# uma vez que remove a variação que ocorre em determinados períodos do ano, como férias e feriados.
  
# **Atividades no Comércio Varejista**: 
# A pesquisa do IBGE classifica as atividades do comércio varejista em várias categorias, como:
# - **Combustíveis e lubrificantes**
# - **Hipermercados, supermercados, produtos alimentícios, bebidas e fumo**
# - **Tecidos, vestuário e calçados**
# - **Móveis e eletrodomésticos**
# - **Artigos farmacêuticos, médicos, ortopédicos, de perfumaria e cosméticos**
# - **Livros, jornais, revistas e papelaria**
# - **Equipamentos e materiais para escritório, informática e comunicação**
# - **Outros artigos de uso pessoal e doméstico**
  
# **Essenciais**: 
# Para a análise, foram classificadas como **essenciais** as atividades que têm impacto direto na necessidade 
# básica de consumo. Isso inclui:
# - **Hipermercados, supermercados, produtos alimentícios, bebidas e fumo**
# - **Artigos farmacêuticos, médicos, ortopédicos, de perfumaria e cosméticos**

# **Não essenciais**: 
# As atividades classificadas como **não essenciais** incluem as demais categorias do comércio, 
# como vestuário, móveis, equipamentos de escritório e outros artigos de uso pessoal.
  
# **Elasticidade do Consumo**: 
# Refere-se à sensibilidade do consumo de um produto ou serviço às variações de fatores econômicos, 
# como o **Índice de Confiança do Consumidor (ICC)**. A elasticidade do consumo indica como a variação 
# do ICC afeta o comportamento do consumidor em termos de volume de compras, sendo mais sensível nos itens **não essenciais**.
  
# **Pandemia e Consumo**: 
# Durante a pandemia de COVID-19, observou-se que os produtos essenciais tiveram um aumento no consumo, 
# enquanto a confiança do consumidor (ICC) caiu significativamente. A análise mostrou que os **produtos essenciais** 
# variaram menos com o ICC e, em períodos de baixa confiança, o consumo desses produtos não caiu tanto quanto o consumo 
# dos **não essenciais**, que apresentaram maior volatilidade.



## Como Reproduzir


# Para reproduzir esta análise, siga os passos abaixo.

# 1. **Instalar e Carregar os Pacotes Necessários**

# A primeira etapa é garantir que você tenha todos os pacotes necessários instalados no R. 
# Os pacotes usados nesta análise são:

# - **tidyverse**: Conjunto de pacotes para manipulação e visualização de dados.
# - **readxl**: Pacote para ler arquivos Excel.
# - **janitor**: Utilizado para limpar e formatar os dados.
# - **lubridate**: Pacote para manipulação de datas.
# - **stringr**: Utilizado para manipulação de strings.
# - **scales**: Para ajustes em gráficos e escalas.

# Você pode instalar todos esses pacotes de uma vez no R com o seguinte comando:

# install.packages(c("tidyverse", "readxl", "janitor", "lubridate", "stringr", "scales"))

# Após instalar os pacotes, basta carregá-los com o comando `library()`.

# 2. **Obter os Dados**

# Nesta análise, foram utilizadas duas bases de dados:

# - **PMC (Pesquisa Mensal do Comércio)**: Você pode obter os dados diretamente no site do IBGE ou a partir de um arquivo Excel já disponível.
# - **ICC (Índice de Confiança do Consumidor)**: Os dados do ICC podem ser baixados diretamente do portal da FGV.

# Certifique-se de ter os arquivos de dados em seu computador e ajuste o caminho do arquivo conforme a localização em sua máquina.

# 3. **Carregar e Limpar os Dados**

# Após obter os arquivos, você precisa carregá-los no R. As bases de dados **PMC** e **ICC** são carregadas com a função `read_excel()`, do pacote **readxl**. 
# Durante o carregamento, os dados precisam ser limpos e preparados para análise. Isso inclui a renomeação de colunas, conversão de datas e a eliminação de valores nulos ou inválidos.

# Além disso, a base **PMC** passa por um processo de transformação para reorganizar os dados em um formato adequado para análise. 
# Uma vez limpos, as bases de dados são integradas, com o **ICC** sendo combinado à base **PMC** usando a função `left_join()`.

# 4. **Classificação dos Dados: Essenciais vs. Não Essenciais**

# Após integrar os dados, a próxima etapa é a classificação das atividades econômicas em **essenciais** e **não essenciais**. 
# Para isso, foram selecionadas algumas categorias da **Pesquisa Mensal do Comércio (PMC)** que são consideradas essenciais, como supermercados e farmácias, e outras que são consideradas não essenciais.

# 5. **Gerar os Gráficos**

# Com os dados preparados, você pode gerar os gráficos. Dois gráficos principais foram criados para visualizar os resultados da análise:

# - **Gráfico 1: Estrutura de Consumo ao Longo do Tempo**: Este gráfico mostra a participação percentual de consumo dos produtos essenciais e não essenciais ao longo do tempo, comparando-os com o Índice de Confiança do Consumidor (ICC).
  
# - **Gráfico 2: Elasticidade do Consumo em Relação ao ICC**: Este gráfico analisa a relação entre as variações no ICC e as variações no consumo dos produtos essenciais e não essenciais, ou seja, como o comportamento de consumo é sensível às mudanças na confiança do consumidor.

# Esses gráficos são gerados utilizando o pacote **ggplot2**, que oferece uma forma poderosa de criar visualizações no R.

# 6. **Como Gerar o HTML**

# Depois de rodar todo o código e gerar os gráficos, você pode gerar um arquivo HTML com os resultados utilizando a função `knit()` no RStudio. 
# Para isso, basta clicar no botão **Knit** na interface do RStudio, e o RMarkdown gerará um arquivo HTML com os gráficos e resultados da análise.

# Este arquivo HTML será uma versão interativa da análise, e você poderá visualizar os gráficos e as interpretações diretamente no seu navegador.


## Referências


# - **Base de Dados PMC (Pesquisa Mensal do Comércio)**: 
#   - IBGE: https://www.ibge.gov.br/estatisticas/economicas/comercio/9094-pesquisa-mensal-do-comercio.html
#   - Fonte de dados para análise do desempenho do comércio varejista no Brasil.

# - **Base de Dados ICC (Índice de Confiança do Consumidor)**:
#   - FGV: https://www.fgv.br/ibrep/indices-de-confianca
#   - Fonte de dados sobre a confiança do consumidor, essencial para entender as variações no consumo.

# - **Pacote `tidyverse`**: 
#   - Documentação oficial: https://ggplot2.tidyverse.org/
#   - Usado para manipulação de dados e visualizações.

# - **Pacote `readxl`**: 
#   - Documentação oficial: https://cran.r-project.org/web/packages/readxl/readxl.pdf
#   - Usado para leitura de arquivos Excel.

# - **Pacote `lubridate`**: 
#   - Documentação oficial: https://cran.r-project.org/web/packages/lubridate/lubridate.pdf
#   - Usado para manipulação de datas.

# - **Utilização de IA para otimização de código**:
#   - **ChatGPT**: Durante a análise, o ChatGPT foi utilizado para tirar dúvidas sobre otimização de código e melhor estruturação das funções.
  
# - **Exemplo de código para RMarkdown**: 
#   - https://bookdown.org/yihui/rmarkdown/
#   - Fonte de referência para a estruturação do código em RMarkdown.

# - **Exemplo de visualização com `ggplot2`**: 
#   - https://ggplot2.tidyverse.org/
#   - Referência para a criação dos gráficos e personalização da visualização.

  
## Conclusão
  
# Durante o período analisado (2006-2025), observou-se que o consumo dos **produtos essenciais** 
# tem uma relação mais estável com a **confiança do consumidor (ICC)**. Já os **produtos não essenciais** 
# mostram maior variação, especialmente em períodos de queda significativa do ICC, como aconteceu durante a pandemia. 
# A elasticidade do consumo foi mais alta nos itens não essenciais, demonstrando que os consumidores ajustaram 
# seu comportamento de compra de forma mais sensível à confiança no mercado.
  
  